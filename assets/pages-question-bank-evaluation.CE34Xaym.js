import{C as e,D as o,E as s,G as t,d as a,r as n,j as l,z as c,c as r,w as i,i as u,A as d,s as f,o as p,a as w,u as v,e as g,f as m,k as h,F as y,m as b,t as k,g as U,n as _}from"./index-DcIKMGjb.js";import{_ as x}from"./_plugin-vue_export-helper.BCo6x5W8.js";function F(e,o){return`作为技术面试官，请对以下回答进行评估，并严格分步返回结果：\n\n                    问题：${e}\n                    答案：${o}\n\n                    请按以下步骤返回 JSON 结果，每一步均为完整对象：\n                    1. 评分（仅含分数）：\n                    {"score": 0-100的整数}\n                    \n                    2. 评价（分数+评价）：\n                    {"score": 同上, "feedback": "面试官口吻的详细评价，中文，非空"}\n                    \n                    3. 建议（分数+评价+建议）：\n                    {"score": 同上, "feedback": 同上, "suggestions": "导师口吻的改进建议，中文，非空"}\n                    \n                    4. 范例（分数+评价+建议+范例）：\n                    {"score": 同上, "feedback": 同上, "suggestions": 同上, "example": "标准答案示例，中文，非空"}\n                    \n                    5. 最终结果（含追问判断）：\n                    {"score": 同上, "feedback": 同上, "suggestions": 同上, "example": 同上, "needFollowUp": true/false, "followUpQuestion": "不要随意追问，若需追问，此处为非空中文问题"}\n                    \n                    注意：\n                    1. score 需综合准确性（0-40）、完整性（0-30）、清晰度（0-20）、逻辑性（0-10）评分。\n                    2. 所有文本字段必须为非空中文，禁止缺失或混合其他语言。\n                    3. 以面试官角度考虑该面试者是否值得追问或引导，若需要则将 needFollowUp 设置为 true，否则为 false。\n                    3. needFollowUp 为 true 时，followUpQuestion 必须是与原问题强相关、能进一步考察候选人技术深度的追问问题，避免开放式提问。\n                `}function S(e){return{model:s.value.model,temperature:s.value.temperature,response_format:{type:"json_object"},messages:[{role:"system",content:"你是一位经验丰富的技术面试官，善于评估候选人的回答并提供建设性的反馈。"},{role:"user",content:e}]}}function Q(e){try{return JSON.parse(e),e}catch(o){return e.endsWith(",")&&(e=e.slice(0,-1)),e.endsWith('"')?e+="}":e.endsWith('"')||e.endsWith("}")||(e+='"}'),e}}function O(){return{baseURL:s.value.baseURL,apiKey:s.value.apiKey}}async function E(s,a,n){return new Promise((async(l,c)=>{try{let i="",u={score:-1,feedback:"",suggestions:"",example:"",needFollowUp:!1,followUpQuestion:""};if("web"===e().uniPlatform)try{return await async function(e,o,s){return new Promise((async(t,a)=>{var n,l,c,r,i;try{let a="",f={score:-1,feedback:"",suggestions:"",example:"",needFollowUp:!1,followUpQuestion:""};const p=O(),w=S(F(e,o)),v=await fetch(`${p.baseURL}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p.apiKey}`,Accept:"text/event-stream"},body:JSON.stringify({...w,stream:!0})});if(!v.ok)throw new Error(`HTTP error! status: ${v.status}`);if(!v.body)throw new Error("Response body is null");const g=v.body.getReader(),m=new TextDecoder;for(;;){const{done:e,value:o}=await g.read();if(e)break;const p=m.decode(o,{stream:!0}).split("\n").filter((e=>""!==e.trim()));for(const w of p)if(w.startsWith("data: ")){const e=w.slice(6);if("[DONE]"===e)continue;try{const o=JSON.parse(e);if(o.error)throw new Error(o.error);if(null==(c=null==(l=null==(n=o.choices)?void 0:n[0])?void 0:l.delta)?void 0:c.content){a+=o.choices[0].delta.content;try{const e=JSON.parse(Q(a));f.score=e.score,f.feedback=e.feedback||"",f.suggestions=e.suggestions||"",f.example=e.example||"",f.needFollowUp=e.needFollowUp||!1,f.followUpQuestion=e.followUpQuestion||"",s(f)}catch(u){}}if("stop"===(null==(i=null==(r=o.choices)?void 0:r[0])?void 0:i.finish_reason))return void t(f)}catch(d){console.error("解析 SSE 数据时出错:",d)}}}t(f)}catch(d){a(d)}}))}(s,a,n||(()=>{}))}catch(r){console.warn("SSE 连接失败，降级使用 WebSocket:",r)}let d=o({url:"ws://localhost:18780",complete:()=>{}});d.onOpen((()=>{const e=O(),o={...S(F(s,a)),baseURL:e.baseURL,apiKey:e.apiKey};d.send({data:JSON.stringify(o),fail:e=>{console.error("发送消息失败:",e),c(new Error("发送消息失败"))}})})),d.onMessage((e=>{var o,s,t,a;try{const r=JSON.parse(e.data);if(r.error)return d.close({}),void c(new Error(r.error));if(null==(s=null==(o=r.choices)?void 0:o[0])?void 0:s.delta){const e=r.choices[0].delta;if(e.content){i+=e.content;try{const e=JSON.parse(Q(i));u.score=e.score,u.feedback=e.feedback||"",u.suggestions=e.suggestions||"",u.example=e.example||"",u.needFollowUp=e.needFollowUp||!1,u.followUpQuestion=e.followUpQuestion||"",n&&n(u)}catch(f){}}}if("stop"===(null==(a=null==(t=r.choices)?void 0:t[0])?void 0:a.finish_reason))return d.close({}),void l(u)}catch(r){console.error("处理消息时出错:",r)}})),d.onError((async e=>{console.warn("WebSocket 连接失败，降级使用 HTTP 请求:",e),u=await async function(o,s){return new Promise(((a,n)=>{const l=O(),c=S(F(o,s));t({url:`${l.baseURL}/chat/completions`,method:"POST",header:{"Content-Type":"application/json",Authorization:`Bearer ${l.apiKey}`},timeout:18e4,data:c,success:o=>{try{const e=o.data.choices[0].message.content,s=JSON.parse(e);a({score:s.score,feedback:s.feedback||"",suggestions:s.suggestions||"",example:s.example||"",needFollowUp:s.needFollowUp||!1,followUpQuestion:s.followUpQuestion||""})}catch(e){n(new Error("解析评估结果失败"))}},fail:e=>{n(new Error("请求评估失败"))}})}))}(s,a),console.warn("降级使用 HTTP 请求结果:",u),n&&n(u),l(u)})),d.onClose((()=>{u.score>=0&&!u.feedback&&!u.suggestions&&l(u)}))}catch(r){c(r)}}))}const T=x(a({__name:"evaluation",setup(e){const o=n({score:-1,feedback:"",suggestions:"",example:"",needFollowUp:!1});l((()=>{var e;const s=null==(e=d())?void 0:e.proxy,t=null==s?void 0:s.getOpenerEventChannel();t&&t.on?t.on("evaluateAnswer",(async e=>{try{const s=await E(e.question,e.answer,(e=>{o.value={score:void 0===e.score?-1:e.score,feedback:e.feedback||"",suggestions:e.suggestions||"",example:e.example||"",needFollowUp:e.needFollowUp||!1,followUpQuestion:e.followUpQuestion||""}}));o.value=s}catch(s){console.error("评估失败",s),f({title:"评估失败，请重试",icon:"none"})}})):c({url:"/pages/index/index"})}));const s=()=>{var e;(null==(e=o.value)?void 0:e.followUpQuestion)&&_({url:"/pages/question-bank/answer",success:e=>{var s;e.eventChannel.emit("setQuestion",{question:null==(s=o.value)?void 0:s.followUpQuestion,isFollowUp:!0})}})};return(e,t)=>{const a=g,n=u,l=U;return p(),r(n,{class:"content"},{default:i((()=>[w(n,{class:"evaluation-section"},{default:i((()=>[w(n,{class:"evaluation-card"},{default:i((()=>[w(n,{class:"score-section"},{default:i((()=>[w(a,{class:"score-label"},{default:i((()=>[m("得分")])),_:1}),w(a,{class:"score-value"},{default:i((()=>[o.value.score<0||!o.value.feedback?(p(),r(a,{key:0,class:"loading-container"},{default:i((()=>[w(a,{class:"loading-text"},{default:i((()=>[m("评估中")])),_:1}),w(a,{class:"loading-dots"},{default:i((()=>[(p(),h(y,null,b(3,(e=>w(a,{class:"dot"},{default:i((()=>[m(".")])),_:1}))),64))])),_:1})])),_:1})):(p(),r(a,{key:1},{default:i((()=>[m(k(o.value.score),1)])),_:1}))])),_:1})])),_:1}),o.value.score<0||!o.value.feedback?(p(),r(n,{key:0,class:"placeholder-sections"},{default:i((()=>[(p(),h(y,null,b(3,(e=>w(n,{class:"placeholder-section"},{default:i((()=>[w(n,{class:"placeholder-title"}),w(n,{class:"placeholder-content"})])),_:1}))),64))])),_:1})):(p(),r(n,{key:1},{default:i((()=>[o.value.feedback?(p(),r(n,{key:0,class:"feedback-section"},{default:i((()=>[w(a,{class:"feedback-title"},{default:i((()=>[m("评价")])),_:1}),w(a,{class:"feedback-content"},{default:i((()=>[m(k(o.value.feedback),1)])),_:1})])),_:1})):v("",!0),o.value.suggestions?(p(),r(n,{key:1,class:"suggestions-section"},{default:i((()=>[w(a,{class:"suggestions-title"},{default:i((()=>[m("建议")])),_:1}),w(a,{class:"suggestions-content"},{default:i((()=>[m(k(o.value.suggestions),1)])),_:1})])),_:1})):v("",!0),o.value.example?(p(),r(n,{key:2,class:"example-section"},{default:i((()=>[w(a,{class:"example-title"},{default:i((()=>[m("范例")])),_:1}),w(a,{class:"example-content"},{default:i((()=>[m(k(o.value.example),1)])),_:1})])),_:1})):v("",!0),o.value.needFollowUp?(p(),r(n,{key:3,class:"follow-up-section"},{default:i((()=>[w(a,{class:"follow-up-title"},{default:i((()=>[m("追问")])),_:1}),w(a,{class:"follow-up-content"},{default:i((()=>[m(k(o.value.followUpQuestion),1)])),_:1})])),_:1})):v("",!0)])),_:1}))])),_:1})])),_:1}),o.value.needFollowUp?(p(),r(l,{key:0,class:"follow-up-btn",onClick:s},{default:i((()=>[m("继续回答")])),_:1})):v("",!0)])),_:1})}}}),[["__scopeId","data-v-f2787f8f"]]);export{T as default};
