var e=Object.defineProperty,t=(t,s,a)=>(((t,s,a)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a})(t,"symbol"!=typeof s?s+"":s,a),a);import{z as s,d as a,r as o,A as n,B as i,c as r,w as l,i as u,C as c,o as d,a as p,u as h,e as v,f,t as m,p as g,g as y,D as w,s as b,n as _}from"./index-e7etKVS4.js";import{_ as k}from"./_plugin-vue_export-helper.BCo6x5W8.js";const x=[];for(let D=0;D<256;++D)x.push((D+256).toString(16).slice(1));let S;const C=new Uint8Array(16);const R={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function U(e,t,s){var a;if(R.randomUUID&&!e)return R.randomUUID();const o=(e=e||{}).random??(null==(a=e.rng)?void 0:a.call(e))??function(){if(!S){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");S=crypto.getRandomValues.bind(crypto)}return S(C)}();if(o.length<16)throw new Error("Random bytes length must be >= 16");return o[6]=15&o[6]|64,o[8]=63&o[8]|128,function(e,t=0){return(x[e[t+0]]+x[e[t+1]]+x[e[t+2]]+x[e[t+3]]+"-"+x[e[t+4]]+x[e[t+5]]+"-"+x[e[t+6]]+x[e[t+7]]+"-"+x[e[t+8]]+x[e[t+9]]+"-"+x[e[t+10]]+x[e[t+11]]+x[e[t+12]]+x[e[t+13]]+x[e[t+14]]+x[e[t+15]]).toLowerCase()}(o)}function I(){return U().replace(/-/g,"")}class P{constructor(e={}){t(this,"websocket",null),t(this,"audioContext",null),t(this,"scriptProcessor",null),t(this,"audioInput",null),t(this,"audioStream",null),t(this,"isRecording",!1),t(this,"options"),this.options=e}connectWebSocket(){var e,t;const{appKey:a,token:o}=s.value;if(!a||!o)return void(null==(t=(e=this.options).onError)||t.call(e,"请先配置语音识别服务的 AppKey 和 Token"));const n=`wss://nls-gateway.cn-shanghai.aliyuncs.com/ws/v1?token=${o}`;this.websocket=new WebSocket(n),this.websocket.onopen=()=>{var e;const t={header:{appkey:a,namespace:"SpeechTranscriber",name:"StartTranscription",task_id:I(),message_id:I()},payload:{format:"pcm",sample_rate:16e3,enable_intermediate_result:!0,enable_punctuation_prediction:!0,enable_inverse_text_normalization:!0}};null==(e=this.websocket)||e.send(JSON.stringify(t))},this.websocket.onmessage=e=>{var t,s;const a=JSON.parse(e.data);"TranscriptionResultChanged"!==a.header.name&&"TranscriptionCompleted"!==a.header.name||null==(s=(t=this.options).onResult)||s.call(t,a.payload.result)},this.websocket.onerror=()=>{var e,t;null==(t=(e=this.options).onError)||t.call(e,"语音识别服务连接失败")},this.websocket.onclose=()=>{this.websocket=null}}async startRecording(){var e,t;try{this.isRecording=!0,this.connectWebSocket(),this.audioStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3}),this.audioInput=this.audioContext.createMediaStreamSource(this.audioStream),this.scriptProcessor=this.audioContext.createScriptProcessor(2048,1,1),this.scriptProcessor.onaudioprocess=e=>{var t;const s=e.inputBuffer.getChannelData(0),a=new Int16Array(s.length);for(let o=0;o<s.length;++o)a[o]=32767*Math.max(-1,Math.min(1,s[o]));(null==(t=this.websocket)?void 0:t.readyState)===WebSocket.OPEN&&this.websocket.send(a.buffer)},this.audioInput.connect(this.scriptProcessor),this.scriptProcessor.connect(this.audioContext.destination)}catch(s){console.error(s),null==(t=(e=this.options).onError)||t.call(e,"录音失败"),this.isRecording=!1}}stopRecording(){this.isRecording=!1,this.scriptProcessor&&(this.scriptProcessor.disconnect(),this.scriptProcessor=null),this.audioInput&&(this.audioInput.disconnect(),this.audioInput=null),this.audioStream&&(this.audioStream.getTracks().forEach((e=>e.stop())),this.audioStream=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.websocket&&(this.websocket.close(),this.websocket=null)}getRecordingStatus(){return this.isRecording}}const E=k(a({__name:"answer",setup(e){const t=o(null),s=o(""),a=o(""),k=o(!1),x=o(!1),S=o(null),C=o("");n((()=>{var e;const s=null==(e=c())?void 0:e.proxy,a=null==s?void 0:s.getOpenerEventChannel();a&&a.on?a.on("setQuestion",(e=>{t.value={content:e.question,difficulty:e.difficulty,category:e.category},x.value=e.isFollowUp||!1,R("text")})):i({url:"/pages/index/index"})}));const R=e=>{s.value=e},U=async()=>{t.value&&a.value.trim()?_({url:"/pages/question-bank/evaluation",success:e=>{var s,o,n;e.eventChannel.emit("evaluateAnswer",{question:null==(s=t.value)?void 0:s.content,answer:a.value,difficulty:null==(o=t.value)?void 0:o.difficulty,category:null==(n=t.value)?void 0:n.category,isFollowUp:x.value})}}):b({title:"请输入答案",icon:"none"})},I=async()=>{S.value||(S.value=new P({onResult:e=>{C.value=e,a.value=e},onError:e=>{b({title:e,icon:"none"})}})),k.value=!0,await S.value.startRecording()},E=()=>{S.value&&(S.value.stopRecording(),k.value=!1)};return(e,o)=>{const n=v,i=u,c=y,b=w;return d(),r(i,{class:"content"},{default:l((()=>[p(i,{class:"quiz-section"},{default:l((()=>[p(i,{class:"question-card"},{default:l((()=>[p(n,{class:"question-text"},{default:l((()=>{var e;return[f(m(null==(e=t.value)?void 0:e.content),1)]})),_:1}),x.value?h("",!0):(d(),r(i,{key:0,class:"question-info"},{default:l((()=>{var e;return[p(n,{class:g(["difficulty",null==(e=t.value)?void 0:e.difficulty])},{default:l((()=>{var e;return[f(m(null==(e=t.value)?void 0:e.difficulty),1)]})),_:1},8,["class"]),p(n,{class:"category"},{default:l((()=>{var e;return[f(m(null==(e=t.value)?void 0:e.category),1)]})),_:1})]})),_:1}))])),_:1}),p(i,{class:"answer-options"},{default:l((()=>[p(c,{class:"answer-btn text",onClick:o[0]||(o[0]=e=>R("text"))},{default:l((()=>[p(n,{class:"btn-text"},{default:l((()=>[f("文字回答")])),_:1})])),_:1}),p(c,{class:"answer-btn voice",onClick:o[1]||(o[1]=e=>R("voice"))},{default:l((()=>[p(n,{class:"btn-text"},{default:l((()=>[f("语音回答")])),_:1})])),_:1})])),_:1}),"text"===s.value?(d(),r(i,{key:0,class:"answer-container"},{default:l((()=>[p(i,{class:"answer-section"},{default:l((()=>[p(b,{class:"answer-input",modelValue:a.value,"onUpdate:modelValue":o[2]||(o[2]=e=>a.value=e),placeholder:"请输入你的答案...",maxlength:-1},null,8,["modelValue"])])),_:1}),p(i,{class:"submit-container"},{default:l((()=>[p(c,{class:"submit-btn",onClick:U},{default:l((()=>[f("提交答案")])),_:1})])),_:1})])),_:1})):"voice"===s.value?(d(),r(i,{key:1,class:"answer-section"},{default:l((()=>[C.value?(d(),r(i,{key:0,class:"recognition-result"},{default:l((()=>[p(n,{class:"result-text"},{default:l((()=>[f(m(C.value),1)])),_:1})])),_:1})):h("",!0),p(c,{class:g(["record-btn",{recording:k.value}]),onTouchstart:I,onTouchend:E},{default:l((()=>[f(m(k.value?"松开结束录音":"按住开始录音"),1)])),_:1},8,["class"])])),_:1})):h("",!0)])),_:1})])),_:1})}}}),[["__scopeId","data-v-8ed5b1ab"]]);export{E as default};
